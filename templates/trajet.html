<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trajet Vertiligne</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="../static/styles.css" />
</head>
<body>

  <div class="container">

    <div class="bottom-blue small">
      <h1 class="logo">Vertiligne</h1>

      <div class="form-box">
        <p class="title">Ton trajet</p>

        <div class="info-title">Départ :</div>
        <div class="info-content" id="depart"></div>

        <div class="info-title">Arrivée :</div>
        <div class="info-content" id="arrivee"></div>

        <div class="info-title">Trajets :</div>
        <div class="trajet-cases">
          <div id="trajet-rapide" class="trajet-case" tabindex="0" role="button" aria-expanded="false" aria-controls="details-rapide">
            <div class="trajet-title">Trajet le plus rapide</div> <!-- titre fixe -->
            <div class="trajet-summary">Chargement...</div>     <!-- durée + icônes -->
            <div id="details-rapide" class="trajet-details"></div>
          </div>

          <div id="trajet-eco" class="trajet-case" tabindex="0" role="button" aria-expanded="false" aria-controls="details-eco">
            <div class="trajet-title">Trajet le plus "respirable"</div> 
            <div class="trajet-summary">Chargement...</div>             
            <div id="details-eco" class="trajet-details"></div>
          </div>
        </div>

      </div>
    </div>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([48.857, 2.35], 13);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
    maxZoom: 18
  }).addTo(map);

  const depart = localStorage.getItem("depart") || "Non défini";
  const arrivee = localStorage.getItem("arrivee") || "Non défini";

  document.getElementById("depart").textContent = depart;
  document.getElementById("arrivee").textContent = arrivee;

  let colorMap = {};
  fetch("http://localhost/api/lines")
    .then(resp => resp.json())
    .then(linesData => {
      linesData.forEach(line => {
        const name = line.name.replace("Ligne ", "");
        colorMap[name] = line.color;
      });
    })
    .catch(error => console.error("Erreur chargement des couleurs lignes :", error));

  // Variables pour markers et tracés trajet (utilisés pour afficher le trajet sur la carte)
  let trajetMarkers = [];
  let trajetLayers = [];
  function clearTrajet() {
    trajetMarkers.forEach(marker => map.removeLayer(marker));
    trajetMarkers = [];
    trajetLayers.forEach(layer => map.removeLayer(layer));
    trajetLayers = [];
  }

  // Affiche le trajet sur la carte avec markers et polylignes
  function displayTrajetOnMap(data) {
    clearTrajet();

    if (!data.steps || data.steps.length === 0) return;

    data.steps.forEach(step => {
      // Pour le point de départ de l'étape
      if (step.from.lat && step.from.lon) {
        // Déterminer niveau pollution, par défaut 1 si absent
        const pollutionLevelFrom = Math.max(0, Math.min(3, step.from.pollution ?? 1));

        const pollutionIconFrom = L.icon({
          iconUrl: `../static/P${pollutionLevelFrom}.png`,
          iconSize: [25, 25],
          iconAnchor: [16, 16],
          popupAnchor: [0, -16]
        });

        const markerFrom = L.marker([step.from.lat, step.from.lon], { icon: pollutionIconFrom }).addTo(map);
        markerFrom.bindPopup(`${step.from.name}`);
        trajetMarkers.push(markerFrom);
      }

      // Pour le point d'arrivée de l'étape
      if (step.to.lat && step.to.lon) {
        const pollutionLevelTo = Math.max(0, Math.min(3, step.to.pollution ?? 1));

        const pollutionIconTo = L.icon({
          iconUrl: `../static/P${pollutionLevelTo}.png`,
          iconSize: [25, 25],
          iconAnchor: [16, 16],
          popupAnchor: [0, -16]
        });

        const markerTo = L.marker([step.to.lat, step.to.lon], { icon: pollutionIconTo }).addTo(map);
        markerTo.bindPopup(`${step.to.name}`);
        trajetMarkers.push(markerTo);
      }

      // Couleur ligne
      const lineName = step.routes[0];
      const color = colorMap[lineName] || "#000000";

      const polyline = L.polyline([[step.from.lat, step.from.lon], [step.to.lat, step.to.lon]], { color }).addTo(map);
      trajetLayers.push(polyline);
    });

    // Ajuste la vue pour afficher tout le trajet
    const group = new L.featureGroup([...trajetMarkers, ...trajetLayers]);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  // Fonction pour afficher résumé minimal (icônes + temps)
  function formatSummary(data) {
    const totalMin = Math.round(data.total_duration / 60);
    const uniqueLines = [...new Set(data.steps.map(step => step.routes[0]))];
    const iconsHtml = uniqueLines.map(line => {
      const imageName = line.toLowerCase().replace("b", "bis");
      return `<img src="../static/${imageName}.png" alt="Ligne ${line}" class="metro-icon" />`;
    }).join(" ");
    return { totalMin, iconsHtml };
  }

  // Fonction pour afficher détails complets dans la case
  function formatDetails(data) {
  if (data.error) return `<p style="color:red;">Erreur : ${data.error}</p>`;
  if (!data.steps || data.steps.length === 0) return `<p>Pas de chemin trouvé.</p>`;

  const totalMin = Math.round(data.total_duration / 60);
  const emissionsMetro = Math.round(((totalMin * 60) * 8.33) / 1000 * 3.8);
  const emissionsVoiture = Math.round(((totalMin * 60) * 8.33) / 1000 * 180);

  let html = `<div><strong>Stations :</strong></div>`;

  let currentLine = null;
  let segmentStations = [];

  function renderSegment(lineName, stations) {
    const color = colorMap[lineName] || "#000000";
    const imageName = lineName.toLowerCase().replace("b", "bis");
    let segmentHtml = `
      <div class="line-segment" style="margin-bottom: 15px;">
        <img src="../static/${imageName}.png" alt="Ligne ${lineName}" class="metro-icon" style="vertical-align:middle; margin-right: 10px;"/>
        <div class="stations-list" style="display: inline-block; vertical-align: middle; border-left: 4px solid ${color}; padding-left: 10px;">
    `;

    stations.forEach(station => {
      segmentHtml += `<div style="margin: 4px 0;">${station}</div>`;
    });

    segmentHtml += `</div></div>`;

    return segmentHtml;
  }

  for (let i = 0; i < data.steps.length; i++) {
    const step = data.steps[i];
    const line = step.routes[0];

    // Si on change de ligne, on affiche le segment précédent et on démarre un nouveau
    if (line !== currentLine) {
      if (segmentStations.length > 0) {
        html += renderSegment(currentLine, segmentStations);
        // Trait gris changement métro sauf pour la toute première ligne
        html += `<div style="margin: 10px 50px; border-left: 4px solid gray; padding-left: 10px; font-style: italic; color: #555;">Changement de métro</div>`;
      }
      currentLine = line;
      segmentStations = [];
    }

    // Pour chaque étape, on ajoute la station de départ
    if (segmentStations.length === 0) {
      segmentStations.push(step.from.name);
    }

    // Toujours ajouter la station d'arrivée de l'étape (pour avoir tous les arrêts)
    segmentStations.push(step.to.name);
  }

  // Afficher le dernier segment restant
  if (segmentStations.length > 0) {
    html += renderSegment(currentLine, segmentStations);
  }


  // Ajout des émissions de CO2
  html += `
    <div>Émissions de CO2 :</div>
    <ul>
      <li>Métro : <strong>${emissionsMetro} gCO2</strong></li>
      <li>Voiture : <strong>${emissionsVoiture} gCO2</strong></li>
      <li>Émissions évitées : <strong>${emissionsVoiture - emissionsMetro} gCO2</strong></li>
    </ul>
  `;

  return html;
}



  // Charger et afficher trajet rapide + affichage carte
  function loadTrajetRapide() {
    fetch(`http://localhost/shortest-path?from=${depart}&to=${arrivee}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("trajet-rapide");
        const summaryDiv = container.querySelector(".trajet-summary");
        const detailsDiv = document.getElementById("details-rapide");

        if(data.error){
          summaryDiv.textContent = "Erreur lors du calcul";
          return;
        }

        const { totalMin, iconsHtml } = formatSummary(data);
        summaryDiv.innerHTML = `${iconsHtml} Durée : <strong>${totalMin} min</strong>`;

        detailsDiv.innerHTML = formatDetails(data);

        // Afficher le trajet rapide sur la carte même si la case est fermée
        displayTrajetOnMap(data);
      })
      .catch(() => {
        const container = document.getElementById("trajet-rapide");
        container.querySelector(".trajet-summary").textContent = "Erreur lors du calcul";
      });
  }

  // Charger et afficher trajet éco + affichage carte
  function loadTrajetEco() {
    // Remplace l'URL par celle correspondant au trajet éco si différente
    fetch(`http://localhost/eco-path?from=${depart}&to=${arrivee}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("trajet-eco");
        const summaryDiv = container.querySelector(".trajet-summary");
        const detailsDiv = document.getElementById("details-eco");

        if(data.error){
          summaryDiv.textContent = "Erreur lors du calcul";
          return;
        }

        const { totalMin, iconsHtml } = formatSummary(data);
        summaryDiv.innerHTML = `${iconsHtml} Durée : <strong>${totalMin} min</strong>`;

        detailsDiv.innerHTML = formatDetails(data);

        if(container.getAttribute("aria-expanded") === "true"){
          displayTrajetOnMap(data);
        }
      })
      .catch(() => {
        const container = document.getElementById("trajet-eco");
        container.querySelector(".trajet-summary").textContent = "Erreur lors du calcul";
      });
  }

  // Gestion du clic pour afficher/masquer détails et afficher le trajet sur la carte
  function toggleDetails(event) {
    const container = event.currentTarget;
    const detailsDiv = container.querySelector(".trajet-details");
    const expanded = container.getAttribute("aria-expanded") === "true";

    if(expanded){
      detailsDiv.style.display = "none";
      container.setAttribute("aria-expanded", "false");
      clearTrajet();
    } else {
      // Fermer l'autre case
      document.querySelectorAll('.trajet-case').forEach(el => {
        if(el !== container){
          el.querySelector(".trajet-details").style.display = "none";
          el.setAttribute("aria-expanded", "false");
        }
      });

      detailsDiv.style.display = "block";
      container.setAttribute("aria-expanded", "true");

      // Afficher le trajet correspondant sur la carte
      if(container.id === "trajet-rapide") {
        loadTrajetRapide();
      } else if(container.id === "trajet-eco") {
        loadTrajetEco();
      }
    }
  }

  // Ajout écouteurs clic et clavier (accessibilité) sur les cases
  document.getElementById("trajet-rapide").addEventListener("click", toggleDetails);
  document.getElementById("trajet-rapide").addEventListener("keydown", e => {
    if(e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      toggleDetails(e);
    }
  });

  document.getElementById("trajet-eco").addEventListener("click", toggleDetails);
  document.getElementById("trajet-eco").addEventListener("keydown", e => {
    if(e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      toggleDetails(e);
    }
  });

  // Initialisation
  loadTrajetRapide();
  loadTrajetEco();

  // Au démarrage, on veut que les deux cases soient fermées (aria-expanded = false)
  // et que les détails soient cachés
  document.getElementById("trajet-rapide").setAttribute("aria-expanded", "false");
  document.getElementById("trajet-rapide").querySelector(".trajet-details").style.display = "none";

  document.getElementById("trajet-eco").setAttribute("aria-expanded", "false");
  document.getElementById("trajet-eco").querySelector(".trajet-details").style.display = "none";
</script>


</body>
</html>

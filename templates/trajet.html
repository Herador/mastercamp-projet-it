<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trajet Vertiligne</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="../static/styles.css" />
</head>
<body>

  <div class="container">

    <div class="bottom-blue small">
      <h1 class="logo">Vertiligne</h1>

      <div class="form-box">
        <p class="title">Ton trajet</p>

        <div class="info-title">Départ :</div>
        <div class="info-content" id="depart"></div>

        <div class="info-title">Arrivée :</div>
        <div class="info-content" id="arrivee"></div>

        <div class="info-title">Trajets :</div>
        <div class="trajet-cases">
          <div id="trajet-rapide" class="trajet-item" tabindex="0" role="button" aria-expanded="false" aria-controls="details-rapide">
            <div class="trajet-title"><strong>le plus rapide</strong> </div> <!-- titre fixe -->
            <div class="trajet-summary">Chargement...</div>     <!-- durée + icônes -->
            <div id="details-rapide" class="trajet-details"></div>
          </div>

          <div id="trajet-eco" class="trajet-item" tabindex="0" role="button" aria-expanded="false" aria-controls="details-eco">
            <div class="trajet-title"><strong>le plus "respirable"</strong> </div> 
            <div class="trajet-summary">Chargement...</div>             
            <div id="details-eco" class="trajet-details"></div>
          </div>
        </div>

      </div>
    </div>

    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([48.857, 2.35], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
  maxZoom: 18
}).addTo(map);



const depart = localStorage.getItem("depart") || "Non défini";
const arrivee = localStorage.getItem("arrivee") || "Non défini";

document.getElementById("depart").textContent = depart;
document.getElementById("arrivee").textContent = arrivee;

let colorMap = {};

// Charger couleurs des lignes et ensuite charger les trajets
function loadColorMap() {
  return fetch("http://localhost/api/lines")
    .then(resp => resp.json())
    .then(linesData => {
      linesData.forEach(line => {
        const name = line.name.replace("Ligne ", "");
        colorMap[name] = line.color;
      });
    })
    .catch(error => {
      console.error("Erreur chargement des couleurs lignes :", error);
      // On laisse colorMap vide, couleurs par défaut seront noires
    });
}

let trajetMarkers = [];
let trajetLayers = [];

function clearTrajet() {
  trajetMarkers.forEach(marker => map.removeLayer(marker));
  trajetMarkers = [];
  trajetLayers.forEach(layer => map.removeLayer(layer));
  trajetLayers = [];
}

function displayTrajetOnMap(data) {
  clearTrajet();
  if (!data.steps || data.steps.length === 0) return;

  data.steps.forEach(step => {
    const lineName = step.routes[0];
    if (!lineName || lineName.toLowerCase().includes("transfer")) {
      // Ignorer les étapes de transfert
      return;
    }

    if (step.from.lat && step.from.lon) {
      const pollutionLevelFrom = Math.max(1, Math.min(4, step.from.pollution ?? 1));
      const pollutionIconFrom = L.icon({
        iconUrl: `../static/P${pollutionLevelFrom}.png`,
        iconSize: [25, 25],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16]
      });
      const markerFrom = L.marker([step.from.lat, step.from.lon], { icon: pollutionIconFrom }).addTo(map);
      markerFrom.bindPopup(`${step.from.name}`);
      trajetMarkers.push(markerFrom);
    }



    const color = colorMap[lineName] || "#000000";
    const polyline = L.polyline([[step.from.lat, step.from.lon], [step.to.lat, step.to.lon]], { color: color,
      weight: 10,
      opacity: 0.8,}).addTo(map);
    trajetLayers.push(polyline);
  });

  const group = new L.featureGroup([...trajetMarkers, ...trajetLayers]);
  map.fitBounds(group.getBounds().pad(0.2));
}

function formatSummary(data) {
  const totalMin = Math.round(data.total_duration / 60);
  const uniqueLines = [...new Set(data.steps.map(step => step.routes[0]))]
    .filter(line => line && !line.toLowerCase().includes("transfer"));
  const iconsHtml = uniqueLines.map(line => {
    const imageName = line.toLowerCase().replace("b", "bis");
    return `<img src="../static/${imageName}.png" alt="Ligne ${line}" class="metro-icon" />`;
  }).join(" ");
  return { totalMin, iconsHtml };
}

function formatDetails(data) {
  if (data.error) return `<p style="color:red;">Erreur : ${data.error}</p>`;
  if (!data.steps || data.steps.length === 0) return `<p>Pas de chemin trouvé.</p>`;

  const totalMin = Math.round(data.total_duration / 60);
  const emissionsMetro = Math.round(((totalMin * 60) * 8.33) / 1000 * 3.8);
  const emissionsVoiture = Math.round(((totalMin * 60) * 8.33) / 1000 * 180);

  let html = `<div><strong>Stations :</strong></div>`;

  let currentLine = null;
  let segmentStations = [];

  function renderSegment(lineName, stations) {
    if (!lineName || lineName.toLowerCase().includes("transfer")) return ""; // ignore transfer lines
    const color = colorMap[lineName] || "#000000";
    const imageName = lineName.toLowerCase().replace("b", "bis");
    let segmentHtml = `
      <div class="line-segment" style="margin-bottom: 15px;">
        <img src="../static/${imageName}.png" alt="Ligne ${lineName}" class="metro-icon" style="vertical-align:middle; margin-right: 10px;"/>
        <div class="stations-list" style="display: inline-block; vertical-align: middle; border-left: 4px solid ${color}; padding-left: 10px;">
    `;

    stations.forEach(station => {
      segmentHtml += `<div style="margin: 4px 0;">${station}</div>`;
    });

    segmentHtml += `</div></div>`;

    return segmentHtml;
  }

  for (let i = 0; i < data.steps.length; i++) {
    const step = data.steps[i];
    const line = step.routes[0];

    if (!line || line.toLowerCase().includes("transfer")) {
      if (segmentStations.length > 0) {
        segmentStations.push(step.to.name);
      }
      continue;
    }

    // Changement de ligne
    if (line !== currentLine) {
      if (segmentStations.length > 0) {
        html += renderSegment(currentLine, segmentStations);
        if (currentLine !== null) {
          html += `<div style="margin: 10px 50px; border-left: 4px solid gray; padding-left: 10px; font-style: italic; color: #555;">Changement de métro</div>`;
        }
      }
      currentLine = line;
      segmentStations = [];
      segmentStations.push(step.from.name);
    }

    // On regarde la ligne de la prochaine étape
    const nextStep = data.steps[i + 1];
    const nextLine = nextStep ? nextStep.routes[0] : null;

    if (line === nextLine) {
      segmentStations.push(step.to.name);
    } else {
      segmentStations.push(step.to.name);
      html += renderSegment(currentLine, segmentStations);
      if (i < data.steps.length - 1) {
        html += `<div style="margin: 10px 50px; border-left: 4px solid gray; padding-left: 10px; font-style: italic; color: #555;">Changement de métro</div>`;
      }
      segmentStations = [];
      currentLine = null;
    }
  }

  // Afficher le dernier segment restant
  if (segmentStations.length > 0) {
    html += renderSegment(currentLine, segmentStations);
  }

  // Ajout des émissions de CO2
  html += `
   <div style="background-color: #d4edda; padding: 10px; border-radius: 5px; margin-top: 15px;">
    <div>Émissions de CO2 :</div>
    <ul>
      <li>Métro : <strong>${emissionsMetro} gCO2</strong></li>
      <li>Voiture : <strong>${emissionsVoiture} gCO2</strong></li>
      <li>Émissions évitées : <strong>${emissionsVoiture - emissionsMetro} gCO2</strong></li>
    </ul>
  </div>`;

  return html;
}

// Charge un trajet, met à jour résumé et détails, affiche sur carte
function loadTrajet(url, containerId, showOnMap = true) {
  fetch(url)
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById(containerId);
      const summaryDiv = container.querySelector(".trajet-summary");
      const detailsDiv = container.querySelector(".trajet-details");

      if (data.error) {
        summaryDiv.textContent = "Erreur lors du calcul";
        detailsDiv.innerHTML = "";
        if (showOnMap) clearTrajet();
        return;
      }

      const { totalMin, iconsHtml } = formatSummary(data);
      summaryDiv.innerHTML = `${iconsHtml} Durée : <strong>${totalMin} min</strong>`;
      detailsDiv.innerHTML = formatDetails(data);

      if (showOnMap) displayTrajetOnMap(data);
    })
    .catch(() => {
      const container = document.getElementById(containerId);
      container.querySelector(".trajet-summary").textContent = "Erreur lors du calcul";
    });
}

// Gestion du clic pour afficher/masquer détails et afficher le trajet sur la carte
function toggleDetails(event) {
  const container = event.currentTarget;
  const detailsDiv = container.querySelector(".trajet-details");
  const expanded = container.getAttribute("aria-expanded") === "true";

  if (expanded) {
    detailsDiv.style.display = "none";
    container.setAttribute("aria-expanded", "false");
    clearTrajet();
  } else {
    // Fermer les autres
    document.querySelectorAll('.trajet-item').forEach(el => { // corrigé ici
      if (el !== container) {
        el.querySelector(".trajet-details").style.display = "none";
        el.setAttribute("aria-expanded", "false");
      }
    });

    detailsDiv.style.display = "block";
    container.setAttribute("aria-expanded", "true");

    // Charger et afficher trajet correspondant
    if (container.id === "trajet-rapide") {
      loadTrajet(`http://localhost/shortest-path?from=${depart}&to=${arrivee}`, "trajet-rapide", true);
    } else if (container.id === "trajet-eco") {
      loadTrajet(`http://localhost/eco-path?from=${depart}&to=${arrivee}`, "trajet-eco", true);
    }
  }
}

// Ajout écouteurs clic et clavier (accessibilité)
["trajet-rapide", "trajet-eco"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("click", toggleDetails);
  el.addEventListener("keydown", e => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      toggleDetails(e);
    }
  });
});

// Initialisation principale : charger couleurs puis trajets sans afficher détails (donc pas afficher sur carte)
loadColorMap().then(() => {
  loadTrajet(`http://localhost/shortest-path?from=${depart}&to=${arrivee}`, "trajet-rapide", true);
  loadTrajet(`http://localhost/eco-path?from=${depart}&to=${arrivee}`, "trajet-eco", false);
});

// Au démarrage, on veut que les deux cases soient fermées et détails cachés
["trajet-rapide", "trajet-eco"].forEach(id => {
  const el = document.getElementById(id);
  el.setAttribute("aria-expanded", "false");
  el.querySelector(".trajet-details").style.display = "none";
});

</script>



</body>
</html>
